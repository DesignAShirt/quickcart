<!DOCTYPE html>
<html>
<head>
  <title></title>
  <script src="STRIPE_PUBLISHABLE_KEY.js"></script>
  <script>
  if (!('STRIPE_PUBLISHABLE_KEY' in this)) {
    alert('Please create ./STRIPE_PUBLISHABLE_KEY.js with the following:\n\nvar STRIPE_PUBLISHABLE_KEY = "pk_[...]";');
  }
  </script>
</head>
<body>

<table id="cartUI" style="width:100%;" border="1">
  <tr>
    <td width="50%" valign="top">
      <button id="customButton" onclick="cart.purchase();">Purchase</button>
      <button onclick="addRandomCart();">Add item to cart</button>
      <button onclick="cart.clear();">Empty cart</button>
      <ul id="basket"></ul>
      <div>
        <span id="items"></span> --
        <span id="total"></span>
      </div>
    </td>
    <td>
      <pre id="json"></pre>
    </td>
  </tr>
</table>

<div id="thanksUI" style="display:none;">
  <h1>Thanks for the order!</h1>
  <button onclick="show('basket');">Place another</button>
</div>

<script src="../bower_components/eventemitter2/lib/eventemitter2.js"></script>
<script src="../lib/cart.js"></script>
<script src="https://checkout.stripe.com/v2/checkout.js"></script>
<script>
function stripePaymentDriver(cart, callback) {
  console.info('Opening stripe checkout');
  StripeCheckout.open({
    key: STRIPE_PUBLISHABLE_KEY, // enter here or create a script matching the placeholder in <head> above
    address: true,
    amount: cart.total,
    currency: 'usd',
    name: 'My Company, LLC',
    image: 'https://stripe.com/img/documentation/checkout/marketplace.png',
    description: cart.count + ' widgets',
    panelLabel: 'Checkout',
    token: function(token) {
      console.info('Stripe token returned', token);
      cart.options.meta.stripe = token.id;
      callback(null, true);
    },
    closed: function() {
      callback(new Error('some async err'));
      // callback(null, false);
    }
  });
}

var cart = new Cart({
  paymentDriver: stripePaymentDriver
});
var cartUI = document.querySelector('#cartUI');
var thanksUI = document.querySelector('#thanksUI');
var basket = document.querySelector('#basket');
var items = document.querySelector('#items');
var total = document.querySelector('#total');
var json = document.querySelector('#json');

function show(page) {
  cartUI.style.display =
  thanksUI.style.display = 'none';
  switch (page) {
    case 'basket':
      cartUI.style.display = 'block';
    break;
    case 'thanks':
      thanksUI.style.display = 'block';
    break;
  }
}

function drawBasketItem(item) {
  console.debug('Drawing basket UI for %s', item.id);
  var li = document.createElement('li')
    , btn = document.createElement('button')
    , div = document.createElement('div');
  li.appendChild(div);
  li.appendChild(btn);
  btn.innerHTML = 'remove';
  btn.onclick = function() {
    console.info('Remove button clicked for %s', item.id);
    cart.remove(item);
  };
  item.element = div;
  updateBasketItem(item);
  basket.appendChild(li);
}

function removeBasketItem(item) {
  console.debug('Removing basket UI for %s', item.id);
  var container = item.element.parentNode.parentNode;
  container.removeChild(item.element.parentNode);
}


function updateBasketItem(item) {
  console.debug('Updating UI for %s', item.id);
  item.element.innerHTML = '<b>Product #' + item.id + '</b><br>' + item.price + ' &times; ' + item.quantity + ' = ' + toDollars(item.subtotal);
}

function toDollars(amt) {
  return '$' + (amt / 100).toFixed(2);
}

function addRandomCart(additions) {
  additions = additions || 1;
  var items = [];
  for (var i=0; i < additions; i++) {
    var item = new Cart.Item({ price: Math.ceil(Math.random()*1000), quantity: Math.ceil(Math.random()*10)+1 });
    console.info('Adding new item %s', item.id);
    items.push(item);
  }
  cart.add(items);
}

addRandomCart(5);

// setInterval(addRandomCart, 5000);

function cartItemEvent(evtName, handler) {
  cart.on(evtName, function(item) {
    console.log('Cart event -> %s for %s', evtName, item.id);
    handler(item);
  });
}

cartItemEvent('item:add', drawBasketItem);
cartItemEvent('item:remove', removeBasketItem);
cartItemEvent('item:change', updateBasketItem);
cartItemEvent('item:error', function(err){ console.error(err); });

cart.on('error', function(err){ console.error(err); });

cart.on('count', function() {
  console.log('Cart event -> count');
  items.innerHTML = cart.count + ' items in cart';
  json.innerHTML = JSON.stringify(cart, null, 2);
});
cart.on('total', function() {
  console.log('Cart event -> total');
  total.innerHTML = toDollars(cart.total);
  console.info('Total updated to %s', total.innerHTML);
});
cart.on('purchase', function(successful) {
  console.log('Cart event -> purchase');
  if (successful) {
    show('thanks');
    cart.clear();
  }
  else {
    console.warn('Purchase was not successful; Cancelled by the user');
  }
});
</script>
</body>
</html>
